#!/usr/bin/env bash
set -euo pipefail

show_help() {
  cat <<'EOF'
Usage: commit-ai [-t TYPE]

Summarize current changes with AI and generate a commit message.

Options:
  -t, --type   Commit type: fix, chore, feature
  -h, --help   Show this help

Config (~/.commitrc):
  COMMIT_SERVER="https://api.openai.com"
  COMMIT_MODEL="gpt-4o-mini"
  COMMIT_API_KEY="..."
  COMMIT_AUTH_HEADER="Authorization: Bearer ..."
EOF
}

commit_type=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    -t|--type)
      commit_type="${2:-}"
      shift 2
      ;;
    -h|--help)
      show_help
      exit 0
      ;;
    *)
      echo "Unknown arg: $1" >&2
      show_help
      exit 1
      ;;
  esac
done

if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "Not a git repository." >&2
  exit 1
fi

if [[ ! -f "$HOME/.commitrc" ]]; then
  echo "Missing config: $HOME/.commitrc" >&2
  exit 1
fi

# shellcheck source=/dev/null
source "$HOME/.commitrc"

server="${COMMIT_SERVER:-}"
model="${COMMIT_MODEL:-}"
api_key="${COMMIT_API_KEY:-}"
auth_header="${COMMIT_AUTH_HEADER:-}"

if [[ -z "$server" || -z "$model" ]]; then
  echo "COMMIT_SERVER and COMMIT_MODEL must be set in ~/.commitrc" >&2
  exit 1
fi

if [[ -z "$auth_header" ]]; then
  if [[ -z "$api_key" ]]; then
    echo "COMMIT_API_KEY or COMMIT_AUTH_HEADER must be set in ~/.commitrc" >&2
    exit 1
  fi
  auth_header="Authorization: Bearer $api_key"
fi

diff="$(git diff --cached)"
diff_scope="staged"
if [[ -z "$diff" ]]; then
  diff="$(git diff)"
  diff_scope="unstaged"
fi

if [[ -z "$diff" ]]; then
  echo "No changes found (staged or unstaged)." >&2
  exit 1
fi

branch="$(git rev-parse --abbrev-ref HEAD)"
jira="$(echo "$branch" | grep -Eo '[A-Z]+-[0-9]+' | head -n 1 || true)"
if [[ -z "$jira" ]]; then
  while [[ -z "$jira" ]]; do
    read -r -p "Jira key (e.g. COOL-1234): " jira
  done
fi

if [[ -z "$commit_type" ]]; then
  echo "Select type:"
  PS3="Type number: "
  select choice in fix chore feature; do
    if [[ -n "${choice:-}" ]]; then
      commit_type="$choice"
      break
    fi
    echo "Invalid selection."
  done
fi

case "$commit_type" in
  fix|chore|feature) ;;
  *)
    echo "Invalid type: $commit_type (use fix|chore|feature)" >&2
    exit 1
    ;;
esac

server="${server%/}"
endpoint="$server/v1/chat/completions"

prompt=$(
  cat <<'EOF'
You are generating a concise git commit message and summary.
Return only JSON in the following format:
{"summary":"...","message":"..."}

Rules:
- summary: 1-3 short bullets separated by "; "
- message: short imperative, max 72 chars, no trailing period
EOF
)

payload="$(
  COMMIT_PROMPT="$prompt" \
  COMMIT_DIFF="$diff" \
  COMMIT_MODEL="$model" \
  COMMIT_SCOPE="$diff_scope" \
  python3 - <<'PY'
import json,sys,os
prompt = os.environ["COMMIT_PROMPT"]
diff = os.environ["COMMIT_DIFF"]
model = os.environ["COMMIT_MODEL"]
scope = os.environ["COMMIT_SCOPE"]
content = f"{prompt}\n\nChanges ({scope}):\n{diff}"
print(json.dumps({
  "model": model,
  "response_format": {
    "type": "json_schema",
    "json_schema": {
      "name": "commit_message",
      "schema": {
        "type": "object",
        "additionalProperties": False,
        "properties": {
          "summary": {"type": "string"},
          "message": {"type": "string"}
        },
        "required": ["summary", "message"]
      }
    }
  },
  "messages": [
    {"role": "user", "content": content}
  ],
  "temperature": 0.2
}))
PY
)"

response="$(
  curl -sS \
    -H "Content-Type: application/json" \
    -H "$auth_header" \
    --data-binary "$payload" \
    "$endpoint"
)"

if [[ -z "$response" ]]; then
  echo "Empty response from server." >&2
  exit 1
fi

content="$(
  COMMIT_RESPONSE="$response" \
  python3 -c '
import json,os,sys
raw=os.environ.get("COMMIT_RESPONSE","")
if not raw.strip():
  sys.stderr.write("Empty response from server.\n")
  sys.exit(1)
try:
  data=json.loads(raw)
except Exception:
  sys.stderr.write("Invalid JSON response\n")
  sys.exit(1)
if "error" in data:
  sys.stderr.write(data["error"].get("message","Server error") + "\n")
  sys.exit(1)
print(data["choices"][0]["message"]["content"])
'
)" || {
  echo "Failed to parse server response as JSON." >&2
  echo "Server response:" >&2
  echo "$response" >&2
  exit 1
}

summary_and_message="$(
  COMMIT_CONTENT="$content" \
  python3 -c '
import json,os,sys
raw=os.environ.get("COMMIT_CONTENT","")
if not raw.strip():
  sys.stderr.write("Empty content from model.\n")
  sys.exit(1)
try:
  data=json.loads(raw)
except Exception:
  sys.stderr.write("Model output is not JSON.\n")
  sys.exit(1)
summary=data.get("summary","").strip()
message=data.get("message","").strip()
if message.endswith("."):
  message=message[:-1]
print(summary)
print("<<<SPLIT>>>")
print(message)
'
)"

summary="${summary_and_message%%$'\n<<<SPLIT>>>'*}"
message="${summary_and_message##*$'\n<<<SPLIT>>>'}"
final_message="${commit_type}(${jira}): ${message}"

echo "Summary ($diff_scope): $summary"
echo "Commit message:"
echo "$final_message"

if [[ "$diff_scope" == "unstaged" ]]; then
  read -r -p "No staged changes. Stage all and commit? [y/N]: " confirm_stage
  if [[ "$confirm_stage" =~ ^[Yy]$ ]]; then
    git add -A
  else
    echo "Aborted: no staged changes to commit." >&2
    exit 1
  fi
fi

git commit -m "$final_message"
